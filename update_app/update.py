import json
import os
import shutil
import time
import psutil
from PyQt5.QtCore import Qt, QThread, pyqtSignal, QTimer
from PyQt5.QtGui import QIcon, QColor
from PyQt5.QtSvg import QSvgWidget
from PyQt5.QtWidgets import (
    QApplication, QWidget, QLabel, QPushButton,
    QVBoxLayout, QGraphicsColorizeEffect, QSizePolicy
)
import sys
from pathlib import Path
import logging

logger = logging.getLogger("update")
logger.setLevel(logging.DEBUG)  # –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

# –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
formatter = logging.Formatter(
    fmt="[{levelname}] {asctime} | {message}",
    datefmt="%H:%M:%S",
    style="{"
)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫: –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å
file_handler = logging.FileHandler("update.log", encoding="utf-8")
file_handler.setFormatter(formatter)
file_handler.setLevel(logging.INFO)

# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –ª–æ–≥–≥–µ—Ä—É (–µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç)
if not logger.handlers:
    logger.addHandler(file_handler)

def get_directory():
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤"""
    if getattr(sys, 'frozen', False):
        if hasattr(sys, '_MEIPASS'):
            return sys._MEIPASS  # onefile —Ä–µ–∂–∏–º
        base = Path(sys.executable).parent
        internal = base / '_internal'
        return internal if internal.exists() else base
    return Path(__file__).parent  # —Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞)

def get_path(*path_parts):
    """–°—Ç—Ä–æ–∏—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å, –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π –≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö"""
    return str(get_directory() / Path(*path_parts))

def get_resource_path(relative_path):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤ –≤–Ω—É—Ç—Ä–∏/—Å–Ω–∞—Ä—É–∂–∏ EXE"""
    if getattr(sys, 'frozen', False):
        if hasattr(sys, '_MEIPASS'):
            # –†–µ–∂–∏–º onefile: —Ä–µ—Å—É—Ä—Å—ã –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–ø–∫–µ _MEIPASS
            base_path = Path(sys._MEIPASS)
        else:
            # –†–µ–∂–∏–º onedir: —Ä–µ—Å—É—Ä—Å—ã –≤ –ø–∞–ø–∫–µ —Å EXE
            base_path = Path(sys.executable).parent
    else:
        # –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        base_path = Path(__file__).parent

    return base_path / relative_path

def get_base_directory():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å –≤ –ª—é–±–æ–º —Ä–µ–∂–∏–º–µ"""
    if getattr(sys, 'frozen', False):
        # –†–µ–∂–∏–º exe (onefile –∏–ª–∏ onedir)
        if hasattr(sys, '_MEIPASS'):
            # onefile —Ä–µ–∂–∏–º - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–∞–ø–∫—É —Å exe, –∞ –Ω–µ –≤—Ä–µ–º–µ–Ω–Ω—É—é
            return Path(sys.executable).parent
        # onedir —Ä–µ–∂–∏–º
        return Path(sys.executable).parent
    # –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    return Path(__file__).parent

class UpdateThread(QThread):
    status_update = pyqtSignal(str, int)
    update_complete = pyqtSignal(bool)

    def __init__(self, root_dir, base_dir, update_pack_dir):
        super().__init__()
        self.root_dir = root_dir
        self.base_dir = base_dir
        self.update_pack_dir = update_pack_dir

    def run(self):
        # –ñ–¥—ë–º –∑–∞–∫—Ä—ã—Ç–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
        self.status_update.emit("–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Assistant.exe...", 0)

        for proc in psutil.process_iter(['name']):
            if proc.info['name'] == 'Assistant.exe':
                try:
                    proc.kill()  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞: {e}")
                    self.update_complete.emit(False)
                    return

        # üî• 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–∫—Ä—ã—Ç (–∂–¥–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 5 —Å–µ–∫)
        for _ in range(5):
            if not any(p.info['name'] == 'Assistant.exe' for p in psutil.process_iter(['name'])):
                break
            time.sleep(1)
        else:
            self.status_update.emit("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å Assistant.exe!", 0)
            self.update_complete.emit(False)
            return

        self.status_update.emit("–£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ñ–∞–π–ª–æ–≤...", 20)
        self.delete_old_files()

        self.status_update.emit("–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤...", 40)
        if self.copy_new_files():
            self.status_update.emit("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.", 100)
            self.update_complete.emit(True)
        else:
            self.status_update.emit("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è!", 0)
            self.update_complete.emit(False)

    def delete_old_files(self):
        preserved = ["user_settings", "update", "update_pack"]

        # –£–¥–∞–ª–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ self.root_dir (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        for item in os.listdir(self.root_dir):
            full_path = os.path.join(self.root_dir, item)
            if os.path.isdir(full_path):
                if os.path.basename(full_path) not in preserved:
                    shutil.rmtree(full_path, ignore_errors=True)
            elif os.path.isfile(full_path):
                if os.path.basename(full_path) != "Assistant.exe":
                    try:
                        os.remove(full_path)
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤: {e}")
                        pass

        parent_dir = os.path.dirname(self.root_dir)  # –ü–æ–ª—É—á–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –ø–∞–ø–∫—É
        assistant_exe_path = os.path.join(parent_dir, "Assistant.exe")

        if os.path.isfile(assistant_exe_path):
            try:
                os.remove(assistant_exe_path)
                logger.info(f"–£–¥–∞–ª—ë–Ω {assistant_exe_path}")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è {assistant_exe_path}: {e}")

    def copy_new_files(self):
        try:
            # –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ _internal –≤–Ω—É—Ç—Ä–∏ update_pack
            update_internal_dir = os.path.join(self.update_pack_dir, "_internal")

            # –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ _internal –∏–∑ update_pack –≤ —Ü–µ–ª–µ–≤—É—é _internal, –∫—Ä–æ–º–µ user_settings
            if os.path.exists(update_internal_dir):
                for item in os.listdir(update_internal_dir):
                    if item == "user_settings":
                        continue
                    if item == "Update.exe":
                        continue

                    src = os.path.join(update_internal_dir, item)
                    dst = os.path.join(self.root_dir, item)

                    # –ü—Ä–æ–±—É–µ–º 3 —Ä–∞–∑–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
                    for _ in range(5):  # 5 –ø–æ–ø—ã—Ç–æ–∫
                        try:
                            if os.path.isdir(src):
                                shutil.copytree(src, dst, dirs_exist_ok=True)
                            else:
                                # –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª
                                if os.path.exists(dst):
                                    try:
                                        os.rename(dst, dst + ".old")
                                    except:
                                        pass
                                shutil.copy2(src, dst)
                            break
                        except Exception:
                            time.sleep(1)

            # –ö–æ–ø–∏—Ä—É–µ–º Assistant.exe –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ
            assistant_src = os.path.join(self.update_pack_dir, "Assistant.exe")
            if os.path.exists(assistant_src):
                parent_dir = os.path.dirname(self.root_dir)  # –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –ø–∞–ø–∫–∞
                assistant_dst = os.path.join(parent_dir, "Assistant.exe")
                shutil.copy2(assistant_src, assistant_dst)

            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
            return False


class UpdateWindow(QWidget):
    def __init__(self):
        super().__init__()
        self.thread = None
        self.setWindowIcon(QIcon(get_path('icon.ico')))
        self.style_path = get_path('color.json')
        self.svg_path = get_path("owl_start.svg")
        self.style_manager = ApplyColor(self.style_path)
        self.styles = self.style_manager.load_styles()
        self.init_ui()
        self.apply_styles()
        self.start_update_process()

    def init_ui(self):
        self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint)
        self.setAttribute(Qt.WA_TranslucentBackground)
        self.setFixedSize(250, 250)

        screen_geometry = QApplication.primaryScreen().availableGeometry()
        self.move(
            int((screen_geometry.width() - self.width()) / 2),
            int((screen_geometry.height() - self.height()) / 2)
        )
        layout = QVBoxLayout()
        layout.setAlignment(Qt.AlignCenter)

        self.main_widget = QWidget()
        self.main_widget.setStyleSheet("""border-radius:20px""")
        content_layout = QVBoxLayout(self.main_widget)
        content_layout.setContentsMargins(15, 0, 15, 20)
        content_layout.addStretch()

        self.svg_image = QSvgWidget()
        self.svg_image.load(self.svg_path)
        self.svg_image.setFixedSize(130, 120)
        self.svg_image.setStyleSheet("""
                            background: transparent;
                            border: none;
                            outline: none;
                        """)
        self.color_svg = QGraphicsColorizeEffect()
        self.svg_image.setGraphicsEffect(self.color_svg)
        content_layout.addWidget(self.svg_image, alignment=Qt.AlignCenter)

        # –¢–µ–∫—Å—Ç
        self.label = QLabel("–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã...")
        self.label.setAlignment(Qt.AlignCenter)
        self.label.setWordWrap(True)
        content_layout.addWidget(self.label)

        self.progress = QLabel("‚ñà" * 10)
        self.progress.setFixedWidth(200)
        self.progress.setAlignment(Qt.AlignCenter)
        self.progress.setStyleSheet("font-family: monospace;")
        self.progress.setSizePolicy(QSizePolicy.Fixed, QSizePolicy.Fixed)

        content_layout.addWidget(self.progress)

        # –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
        self.error_button = QPushButton("–ó–∞–∫—Ä—ã—Ç—å")
        self.error_button.clicked.connect(self.quit_application)
        self.error_button.setStyleSheet("""width:100px; border-radius:5px""")
        self.error_button.hide()
        content_layout.addWidget(self.error_button, alignment=Qt.AlignCenter)

        self.setLayout(layout)
        layout.addWidget(self.main_widget, 1)

    def apply_styles(self):
        try:
            self.styles = self.style_manager.load_styles()

            # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ SVG
            self.style_manager.apply_color_svg(self.svg_image, strength=0.95)
            self.style_manager.apply_progressbar(key="QPushButton", widget=self.progress)

            # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —Å—Ç–∏–ª—è –æ–∫–Ω–∞
            if hasattr(self, 'central_widget'):
                self.central_widget.setObjectName("CentralWidget")
            if hasattr(self, 'title_bar_widget'):
                self.title_bar_widget.setObjectName("TitleBar")
            if hasattr(self, 'container'):
                self.title_bar_widget.setObjectName("ConfirmDialogContainer")
            # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ —Ç–µ–∫—É—â–µ–º—É –æ–∫–Ω—É
            style_sheet = ""
            for widget, styles in self.styles.items():
                if widget.startswith("Q"):  # –î–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, QMainWindow, QPushButton)
                    selector = widget
                else:  # –î–ª—è –≤–∏–¥–∂–µ—Ç–æ–≤ —Å objectName (–Ω–∞–ø—Ä–∏–º–µ—Ä, TitleBar, CentralWidget)
                    selector = f"#{widget}"

                style_sheet += f"{selector} {{\n"
                for prop, value in styles.items():
                    style_sheet += f"    {prop}: {value};\n"
                style_sheet += "}\n"

            self.setStyleSheet(style_sheet)

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ –º–µ—Ç–æ–¥–µ apply_styles: {e}")

    def start_update_process(self):
        if self.thread is not None:
            return  # –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        self.label.setText("–ü—Ä–æ–≤–µ—Ä–∫–∞...")

        root_dir = get_base_directory()  # –ö–æ—Ä–µ–Ω—å (Assistant/)
        update_pack_dir = root_dir / "update_pack"

        # --- –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ update_pack ---
        if not os.path.exists(update_pack_dir):
            self.label.setText("–ü–∞–ø–∫–∞ update_pack –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            self.show_error("–ü–∞–ø–∫–∞ update_pack –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return

        if self.is_folder_empty(update_pack_dir):
            self.label.setText("–ü–∞–ø–∫–∞ update_pack –ø—É—Å—Ç–∞")
            self.show_error("–ü–∞–ø–∫–∞ update_pack –ø—É—Å—Ç–∞")
            return

        self.label.setText("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ...")
        self.thread = UpdateThread(
            root_dir=root_dir,
            base_dir=os.path.dirname(root_dir),
            update_pack_dir=update_pack_dir
        )
        self.thread.status_update.connect(self.set_status)
        self.thread.update_complete.connect(self.on_update_complete)
        self.thread.start()

    def is_folder_empty(self, folder):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π —Å–∫—Ä—ã—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤"""
        visible_files = [f for f in os.listdir(folder) if not f.startswith('.')]
        return len(visible_files) == 0

    def on_update_complete(self, success):
        if success:
            QTimer.singleShot(1000, self.run_main_app)
        else:
            self.show_error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É.")

    def run_main_app(self):
        main_app = os.path.join(os.path.dirname(get_base_directory()), "Assistant.exe")
        if os.path.exists(main_app):
            os.startfile(main_app)
        self.close()

    def set_status(self, text, progress=None):
        self.label.setText(text)
        if progress is not None:
            self.progress.setText("‚ñà" * int(progress / 5))

    def show_error(self, message):
        self.label.setText(message)
        self.error_button.show()

    def quit_application(self):
        sys.exit(1)

#     def start_update_process(self):
#         if self.thread is not None:
#             return  # –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
#
#         self.label.setText("–ó–∞–ø—É—Å–∫ –∏–º–∏—Ç–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...")
#
#         # === –í–†–ï–ú–ï–ù–ù–ê–Ø –ó–ê–ú–ï–ù–ê: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–∏—Ç–∞—Ü–∏—é ===
#         self.thread = MockUpdateThread()
#         # ==========================================
#
#         self.thread.status_update.connect(self.set_status)
#         self.thread.update_complete.connect(self.on_update_complete)
#         self.thread.start()
#
# class MockUpdateThread(QThread):
#     status_update = pyqtSignal(str, int)  # —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–æ—Ü–µ–Ω—Ç
#     update_complete = pyqtSignal(bool, str)
#
#     def __init__(self):
#         super().__init__()
#
#     def run(self):
#         steps = [
#             "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...",
#             "–ê–Ω–∞–ª–∏–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...",
#             "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤...",
#             "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π...",
#             "–û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
#         ]
#
#         for i, step in enumerate(steps):
#             # –ò–º–∏—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã
#             for progress in range(0, 101, 5):  # 0, 5, 10, ..., 100
#                 self.status_update.emit(f"{step} {progress}%", progress + i * 20 // len(steps))
#                 time.sleep(0.03)  # –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
#
#             # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
#             time.sleep(0.2)
#
#         # –ó–∞–≤–µ—Ä—à–∞–µ–º
#         self.update_complete.emit(True, "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")

class ApplyColor():
    def __init__(self, new_color=None, parent=None):
        self.parent = parent  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ –æ–∫–Ω–æ
        self.color_path = get_path('user_settings', 'color_settings.json')
        self.default_color_path = get_path('color_presets', 'default.json')
        self.styles = {}
        if new_color:
            self.color_path = new_color

    def load_styles(self):
        """–¢–æ–ª—å–∫–æ –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∏–ª–µ–π –±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è"""
        try:
            with open(self.color_path, 'r') as file:
                self.styles = json.load(file)
        except (FileNotFoundError, json.JSONDecodeError):
            try:
                with open(self.default_color_path, 'r') as default_file:
                    self.styles = json.load(default_file)
            except (FileNotFoundError, json.JSONDecodeError):
                self.styles = {}
        return self.styles

    def apply_to_widget(self, widget, widget_name):
        """–ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å—Ç–∏–ª—å –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –≤–∏–¥–∂–µ—Ç—É"""
        if widget_name in self.styles:
            widget.setStyleSheet(self.format_style(self.styles[widget_name]))

    def apply_color_svg(self, svg_widget: QSvgWidget, strength: float) -> None:
        """–ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ü–≤–µ—Ç –∫ SVG –≤–∏–¥–∂–µ—Ç—É"""
        if "TitleBar" in self.styles and "border-bottom" in self.styles["TitleBar"]:
            border_parts = self.styles["TitleBar"]["border-bottom"].split()
            for part in border_parts:
                if part.startswith('#'):
                    color_effect = QGraphicsColorizeEffect()
                    color_effect.setColor(QColor(part))
                    svg_widget.setGraphicsEffect(color_effect)
                    color_effect.setStrength(strength)
                    break

    def format_style(self, style_dict):
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç–∏–ª—å –≤ —Å—Ç—Ä–æ–∫—É"""
        return '; '.join(f"{key}: {value}" for key, value in style_dict.items())

    def get_color_from_border(self, widget_key):
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ü–≤–µ—Ç –∏–∑ CSS-—Å–≤–æ–π—Å—Ç–≤–∞ border"""
        try:
            if widget_key and widget_key in self.styles:
                style = self.styles[widget_key]
                border_value = style.get("border", "")

                # –ò—â–µ–º —Ü–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–∞—Ö: #RRGGBB, rgb(), rgba()
                import re
                color_match = re.search(
                    r'#(?:[0-9a-fA-F]{3}){1,2}|rgb\([^)]*\)|rgba\([^)]*\)',
                    border_value
                )
                return color_match.group(0) if color_match else "#05B8CC"  # –¶–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞: {e}")
        return "#05B8CC"  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

    def apply_progressbar(self, key=None, widget=None, style="solid"):
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å—Ç–∏–ª—å –∫ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—É
        :param style: —Å—Ç–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–æ—Å–∫–∏
        :param key: –ö–ª—é—á –∏–∑ —Å—Ç–∏–ª–µ–π –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "QPushButton")
        :param widget: –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–∂–µ—Ç QProgressBar
        """
        if not widget or not hasattr(widget, 'setStyleSheet'):
            logger.warning("–ù–µ –ø–µ—Ä–µ–¥–∞–Ω –≤–∏–¥–∂–µ—Ç –∏–ª–∏ –æ–Ω –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—é")
            return

        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –∏–∑ —Å—Ç–∏–ª–µ–π –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            color = self.get_color_from_border(key) if key else "#05B8CC"

            if style == "solid":
                progress_style = f"""
                    QProgressBar {{
                        border: 1px solid {self.adjust_color(color, brightness=-30)};
                        height: 20px;
                        text-align: center;
                    }}
                    QProgressBar::chunk {{
                        background: qlineargradient(
                            x1:0, y1:0, x2:1, y2:0,
                            stop:0 {self.adjust_color(color, brightness=-10)},
                            stop:1 {color}
                        );
                    }}
                """
            else:
                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∏–ª—å —Å –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π
                progress_style = f"""
                    QProgressBar {{
                        border: 1px solid {self.adjust_color(color, brightness=-30)};
                        border-radius: 5px;
                        background: {self.adjust_color(color, brightness=-80)};
                        height: 20px;
                        text-align: center;
                    }}
                    QProgressBar::chunk {{
                        background: qlineargradient(
                            x1:0, y1:0, x2:1, y2:0,
                            stop:0 {self.adjust_color(color, brightness=-10)},
                            stop:1 {color}
                        );
                        border-radius: 2px;
                        width: 20px;
                        margin: 1px;
                    }}
                """
            widget.setStyleSheet(progress_style)

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞: {e}")
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π —Å—Ç–∏–ª—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
            widget.setStyleSheet("""
                QProgressBar {
                    border: 1px solid #cccccc;
                    border-radius: 5px;
                }
                QProgressBar::chunk {
                    background-color: #05B8CC;
                }
            """)

    def adjust_color(self, color, brightness=0):
        """
        –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç —è—Ä–∫–æ—Å—Ç—å —Ü–≤–µ—Ç–∞
        :param color: –ò—Å—Ö–æ–¥–Ω—ã–π —Ü–≤–µ—Ç (hex/rgb/rgba)
        :param brightness: –ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç -100 –¥–æ 100
        :return: –ù–æ–≤—ã–π —Ü–≤–µ—Ç –≤ hex-—Ñ–æ—Ä–º–∞—Ç–µ
        """
        from PyQt5.QtGui import QColor
        try:
            qcolor = QColor(color)
            if brightness > 0:
                return qcolor.lighter(100 + brightness).name()
            elif brightness < 0:
                return qcolor.darker(100 - brightness).name()
            return qcolor.name()
        except:
            return color

def main():
    app = QApplication(sys.argv)
    window = UpdateWindow()
    window.show()
    sys.exit(app.exec_())


if __name__ == "__main__":
    main()